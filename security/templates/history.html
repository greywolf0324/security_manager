{% extends 'layouts/base.html' %}

{% block content %}

<div class="table-responsive container mt-5">
  <div class="row" style="align-items: end;">
    <div class="col-1">
      <button class="btn btn-outline-success my-2 my-sm-0" type="button" id="refreshButton" onclick="refreshPage()">
        <i class="fa fa-refresh" style="font-size:15px"></i> Refresh
      </button>
    </div>
    <div class="col-3">
      <label class="form-label">Filter</label>

      <select class="form-select" id="filter-option" name="filter-option">
        <option value="all">Select Filter</option>
        <option value="customerName">Customer Name</option>
        <option value="userName">User Name</option>
        <option value="creationDate">Creation Date</option>
        <option value="poDate">PO Date</option>
      </select>

    </div>  
    <div class="col-4">
      <form class="form-inline">
        <input class="form-control mr-sm-2" id="searchInput" style="width: 70%;" type="search" placeholder="Search" aria-label="Search">
        <button class="btn btn-outline-success my-2 my-sm-0" id="searchButton" type="button"><i class="fa fa-search" style="font-size:15px"></i></button>
      </form>
    </div>  
  </div>
  <div class="row mt-4">
    
    <style>
      #history thead, #history tbody tr {
          display: table;
          width: 100%;
          table-layout: fixed;
      }
      #history tbody {
          height: calc(100vh - 448px);
          table-layout: fixed;
          overflow: auto;
          display: block;
          width: 100%;
      }
      .container{
        max-width: 1324px !important;
      }
    </style>
    <table class="table" id="history">
      <thead>
        <tr>
          <th style="width: 5%;"><input type="checkbox" id="masterCheckbox" name="checkbox" onchange="toggleCheckboxes(this)"></th>
          <th onclick="sortTable(1)" class="sortable-column">Customer Name <span id="sortSymbol1" class="order-symbol">&#x02191;</span></th>
          <th onclick="sortTable(2)" class="sortable-column">User Name <span id="sortSymbol2" class="order-symbol">&#x02191;</span></th>
          <th onclick="sortTable(3)" class="sortable-column">Creation Date <span id="sortSymbol3" class="order-symbol">&#x02191;</span></th>
          <th onclick="sortTable(4)" class="sortable-column" style="padding-left: 40px;">PO Date <span id="sortSymbol4" class="order-symbol">&#x02191;</span></th>
          <th></th>
        </tr>
      </thead>

      {% if histories != "empty" %}
      <tbody>
        {% for history in histories %}
        <tr class="table-row">
          <td style="width: 5%;"><input type="checkbox" class="subCheckbox" id="checkbox" name="checkbox" onchange="updateMasterCheckbox()"></td>
          <td>{{ history.0 }}</td>
          <td>{{ history.1 }}</td>
          <td>{{ history.2 }}</td>
          <td style="padding-left: 40px;">{{ history.3 }}</td>
          <td class="text-center">
            <form method="post">
              {% csrf_token %}
              <a type="submit" class="btn btn-primary" href="{% url 'security:history_view' history.2 %}"
                id="history_viewer">View</a>
            </form>
          </td>

        </tr>
        {% endfor %}
      </tbody>
      {% endif %}
    </table>
  </div>
  <div class="black-line" style = "width: 100%; height: 7px; background-color: darkslategray"></div>
  <div class="row mt-5">
      <div class="col-10"></div>
      <div class="col-2 d-flex align-items-end justify-content-start ps-5 ">
        <!-- <button class="btn btn-danger text-white w-50" id="delete-btn">Delete</button> -->
        <form id="yourForm">
          <!-- your table content with checkboxes -->
          <!-- <input type="button" value="Delete" id="deleteButton" class="btn btn-danger text-white"> -->
          <button class="btn btn-danger text-white rounded" id="deleteButton">
            <i class="fa fa-trash"></i><span style="font-size: 16px; font-weight: bold;">Delete</span> 
          </button>
      </form>
      </div>
  </div>
</div>


<script>
  console.log("{{ real }}", "____")
  console.log("{{ history }}", "____")
  console.log("{{ new.0.output }}", "____")
</script>

<script>
  function toggleCheckboxes(masterCheckbox) {
    var checkboxes = document.getElementsByClassName("subCheckbox");
    for (var i = 0; i < checkboxes.length; i++) {
      checkboxes[i].checked = masterCheckbox.checked;
    }
  }

  function updateMasterCheckbox() {
    var masterCheckbox = document.getElementById("masterCheckbox");
    var checkboxes = document.getElementsByClassName("subCheckbox");
    masterCheckbox.checked = true;
    for (var i = 0; i < checkboxes.length; i++) {
      if (!checkboxes[i].checked) {
        masterCheckbox.checked = false;
        break;
      }
    }
  }
</script>


  <script>
  let sortOrder = 1; // 1 for ascending, -1 for descending
  let sortedColumn = 0;

  // document.addEventListener("DOMContentLoaded", function () {
  //   const searchInput = document.getElementById("searchInput");
  //   const tableRows = document.querySelectorAll(".table-row");

  //   searchInput.addEventListener("input", function () {
  //     const searchText = this.value.toLowerCase();

  //     tableRows.forEach(function (row) {
  //       const rowData = row.textContent.toLowerCase();
  //       row.style.display = rowData.includes(searchText) ? "" : "none";
  //     });
  //   });
  // });
  
  // document.addEventListener("DOMContentLoaded", function () {
  //   const searchInput = document.getElementById("searchInput");
  //   const filterOption = document.getElementById("filter-option");
  //   const searchButton = document.getElementById("searchButton");
  //   const tableRows = document.querySelectorAll(".table-row");

  //   // Attach event listeners to both the search button and search input
  //   searchButton.addEventListener("click", function (event) {
  //     event.preventDefault();
  //     filterTableRows();
  //   });

  //   searchInput.addEventListener("input", function () {
  //     filterTableRows();
  //   });

  //   function filterTableRows() {
  //     const searchText = searchInput.value.toLowerCase();
  //     const selectedFilter = filterOption.value.toLowerCase();

  //     tableRows.forEach(function (row) {
  //       let displayRow = false;

  //       // Check if the row contains the specified filter column
  //       const filterColumnIndex = getColumnIndexByName(selectedFilter);
  //       if (filterColumnIndex !== -1) {
  //         const filterValue = row.cells[filterColumnIndex];
  //         if (filterValue) {
  //           // Check if the cell exists before accessing its textContent
  //           const filterText = filterValue.textContent.toLowerCase();
  //           displayRow = filterText.includes(searchText);
  //         }
  //       } else {
  //         // If no filter column is selected, check all columns for the search text
  //         const rowData = row.textContent.toLowerCase();
  //         displayRow = rowData.includes(searchText);
  //       }

  //       row.style.display = displayRow ? "" : "none";
  //     });
  //   }

  //   function getColumnIndexByName(columnName) {
  //     const headerRow = document.getElementById("history").rows[0];
  //     for (let i = 0; i < headerRow.cells.length; i++) {
  //       if (headerRow.cells[i].textContent.toLowerCase() === columnName) {
  //         return i;
  //       }
  //     }
  //     return -1;
  //   }
  // });

  function extractColumnName(columnText) {
  return columnText.replace(/[^\w\s]/g, '').trim().replace(/\s/g, '');
}

document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchInput");
  const filterOption = document.getElementById("filter-option");
  const searchButton = document.getElementById("searchButton");
  const tableRows = document.querySelectorAll(".table-row");
  const refreshButton = document.getElementById("refreshButton"); 
  searchButton.addEventListener("click", function (event) {
    event.preventDefault();
    filterTableRows();
  });
  function refreshPage() {
    location.reload();
  }
  refreshButton.addEventListener("click", function (event) {
      event.preventDefault();
      refreshPage();
    });
  function filterTableRows() {
    const searchText = searchInput.value.toLowerCase();
    const selectedFilter = filterOption.value.toLowerCase();

    tableRows.forEach(function (row) {
      let displayRow = false;

      const filterColumnIndex = getColumnIndexByName(extractColumnName(selectedFilter));
      if (filterColumnIndex !== -1) {
        const filterValue = row.cells[filterColumnIndex];
        if (filterValue) {
          const filterText = filterValue.textContent.toLowerCase();
          displayRow = filterText.includes(searchText);
        }
      } else {
        const rowData = Array.from(row.cells).map(cell => cell.textContent.toLowerCase()).join(' ');
        displayRow = rowData.includes(searchText);
      }

      row.style.display = displayRow ? "" : "none";
    })
  }

  function getColumnIndexByName(columnName) {
    const headerRow = document.getElementById("history").rows[0];
    for (let i = 0; i < headerRow.cells.length; i++) {
      if (extractColumnName(headerRow.cells[i].textContent.trim().toLowerCase()) === columnName) {
        return i;
      }
    }
    return -1;
  }
});
  
function sortTable(columnIndex) {
    const table = document.getElementById("history");
    const rows = Array.from(table.tBodies[0].rows);
    if (sortedColumn === columnIndex) {
      sortOrder = -sortOrder;
    } else {
      sortOrder = 1;
    }

    rows.sort((a, b) => {
      const aValue = a.cells[columnIndex].textContent.trim();
      const bValue = b.cells[columnIndex].textContent.trim();

      const isDate = (dateString) => /^\d{4}-\d{2}-\d{2}$/.test(dateString);
      const aDate = isDate(aValue) ? new Date(aValue) : null;
      const bDate = isDate(bValue) ? new Date(bValue) : null;

      if (aDate && bDate) {
        return sortOrder * (aDate - bDate);
      } else if (!isNaN(aValue) && !isNaN(bValue)) {
        return sortOrder * (parseFloat(aValue) - parseFloat(bValue));
      } else {
        return sortOrder * aValue.localeCompare(bValue);
      }
    });

    const headerRow = table.rows[0];

    for (let i = 1; i < headerRow.cells.length-1; i++) {
      const orderSymbol = i === columnIndex ? (sortOrder === 1 ? ' &#x02191;' : ' &#x02193;') : '';
      const orderSymbolElement = document.getElementById(`sortSymbol${i}`);
      orderSymbolElement.innerHTML = orderSymbol;
      orderSymbolElement.classList.remove("active");
    }

    const clickedOrderSymbol = document.getElementById(`sortSymbol${columnIndex}`);
    clickedOrderSymbol.classList.add("active");

    while (table.tBodies[0].firstChild) {
      table.tBodies[0].removeChild(table.tBodies[0].firstChild);
    }

    rows.forEach((row) => table.tBodies[0].appendChild(row));

    sortedColumn = columnIndex;
  }
</script>
  {% endblock %}